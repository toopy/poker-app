<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Poker App'</title>
    <!-- Le styles -->
    <link href="/fanstatic/bootstrap/css/bootstrap.css" rel="stylesheet">
    <style type="text/css">

body {
    padding-top: 40px;
    padding-bottom: 40px;
}

.show-grid {
    margin-top: 10px;
    /* margin-bottom: 10px; */
}

.show-grid [class*="span-grid"] {
    background-color: #eee;
    text-align: center;
    -webkit-border-radius: 3px;
    -moz-border-radius: 3px;
    border-radius: 3px;
    min-height: 40px;
    line-height: 40px;
}

.show-grid [class*="span-grid"]:hover {
    background-color: #ddd;
}

.center-div {
    margin: auto;
}

.next,
.prev {
    /* height: 418px; */
    height: 24px;
}

.next i,
.prev i{
    /* margin-top: 200px; */
}

.player-cards {
    margin-top: 14px;
}

.player_stats div.center-div {
    width: 128px;
}

input[type=text] {
    border: none;
    box-shadow: none;
    text-align: center;
    -webkit-box-shadow: none;
    -moz-box-shadow: none;
}

.player_stats input {
    float: left;
    width: 16px;
}

.player_stats input.stats-eval {
    color: green;
    width: 24px;
}

.player_stats input.stats-nows {
    color: red;
}

.player_stats input.stats-wins {
    color: grey;
}

.player_stats input.stats-hands {
    color: grey;
    width: 24px;
}

    </style>
    <link href="/fanstatic/bootstrap/css/bootstrap-responsive.css" rel="stylesheet">
</head>
<body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/index">Poker App'</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li><a href="/index">Play'</a></li>
              <li class="active"><a href="/preview">Learn'</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">

        <div id="poker_table" class="row show-grid">
            <span class="span1 offset1 span-grid prev">
                <i class="icon-chevron-left"></i>
            </span>
            <span class="span1 span-grid next">
                <i class="icon-chevron-right"></i>
            </span>
            <span class="span1 span-grid hideable" id="table_show">
                <i class="icon-road"></i>
            </span>
            <span class="span1 span-grid hideable" id="player_cards_show">
                <i class="icon-heart"></i>
            </span>
            <span class="span1 span-grid hideable" id="player_names_show">
                <i class="icon-user"></i>
            </span>
            <span class="span1 span-grid hideable" id="table_cards_show">
                <i class="icon-fire"></i>
            </span>
            <span class="span1 span-grid preview">
                <i class="icon-search"></i>
            </span>
            <span class="span1 span-grid save">
                <i class="icon-hdd"></i>
            </span>
        </div>

        <div class="row show-grid">
            <div class="span10  offset1">
                <div id="table" class="center-div table" style="display: none"></div>
            </div>
        </div>

        <div class="row show-grid table_cards">
            <div class="span2  offset1">
                <div id="table_card_1" class="center-div"></div>
                <input type="text" id="table_card_1_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="table_card_2" class="center-div"></div>
                <input type="text" id="table_card_2_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="table_card_3" class="center-div"></div>
                <input type="text" id="table_card_3_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="table_card_4" class="center-div"></div>
                <input type="text" id="table_card_4_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="table_card_5" class="center-div"></div>
                <input type="text" id="table_card_5_form" class="span2 img_form">
            </div>
        </div>

        <div class="row show-grid player_cards">
            <div class="span1">
                <div id="player_1_card_1" class="center-div"></div>
                <input type="text" id="player_1_card_1_form" class="span1 img_form">
            </div>
            <div class="span1">
                <div id="player_1_card_2" class="center-div"></div>
                <input type="text" id="player_1_card_2_form" class="span1 img_form">
            </div>
            <div class="span2">
                <div id="player_2_cards" class="center-div player-cards"></div>
                <input type="text" id="player_2_cards_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="player_3_cards" class="center-div player-cards"></div>
                <input type="text" id="player_3_cards_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="player_4_cards" class="center-div player-cards"></div>
                <input type="text" id="player_4_cards_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="player_5_cards" class="center-div player-cards"></div>
                <input type="text" id="player_5_cards_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="player_6_cards" class="center-div player-cards"></div>
                <input type="text" id="player_6_cards_form" class="span2 img_form">
            </div>
        </div>

        <div class="row show-grid player_names">
            <div class="span2">
                <div id="player_1_name" class="center-div"></div>
                <input type="text" id="player_1_name_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="player_2_name" class="center-div"></div>
                <input type="text" id="player_2_name_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="player_3_name" class="center-div"></div>
                <input type="text" id="player_3_name_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="player_4_name" class="center-div"></div>
                <input type="text" id="player_4_name_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="player_5_name" class="center-div"></div>
                <input type="text" id="player_5_name_form" class="span2 img_form">
            </div>
            <div class="span2">
                <div id="player_6_name" class="center-div"></div>
                <input type="text" id="player_6_name_form" class="span2 img_form">
            </div>
        </div>

        <div class="row show-grid tale_infos">
            <div class="span2 offset4">
                <input type="text" id="info_step" class="span2 img_form">
            </div>
            <div class="span2">
                <input type="text" id="info_hand" class="span2 img_form">
            </div>
        </div>

        <div class="row show-grid player_stats">
            <div class="span2">
                <div class="center-div">
                <input type="text" id="player_stat_1_form_eval" class="span2 img_form stats-eval">
                <input type="text" id="player_stat_1_form_now" class="span2 img_form stats-nows">
                <input type="text" id="player_stat_1_form_win" class="span2 img_form  stats-wins">
                <input type="text" id="player_stat_1_form_hands" class="span2 img_form stats-hands">
                </div>
            </div>
            <div class="span2">
                <div class="center-div">
                <input type="text" id="player_stat_2_form_eval" class="span2 img_form stats-eval">
                <input type="text" id="player_stat_2_form_now" class="span2 img_form stats-nows">
                <input type="text" id="player_stat_2_form_win" class="span2 img_form  stats-wins">
                <input type="text" id="player_stat_2_form_hands" class="span2 img_form stats-hands">
                </div>
            </div>
            <div class="span2">
                <div class="center-div">
                <input type="text" id="player_stat_3_form_eval" class="span2 img_form stats-eval">
                <input type="text" id="player_stat_3_form_now" class="span2 img_form stats-nows">
                <input type="text" id="player_stat_3_form_win" class="span2 img_form  stats-wins">
                <input type="text" id="player_stat_3_form_hands" class="span2 img_form stats-hands">
                </div>
            </div>
            <div class="span2">
                <div class="center-div">
                <input type="text" id="player_stat_4_form_eval" class="span2 img_form stats-eval">
                <input type="text" id="player_stat_4_form_now" class="span2 img_form stats-nows">
                <input type="text" id="player_stat_4_form_win" class="span2 img_form  stats-wins">
                <input type="text" id="player_stat_4_form_hands" class="span2 img_form stats-hands">
                </div>
            </div>
            <div class="span2">
                <div class="center-div">
                <input type="text" id="player_stat_5_form_eval" class="span2 img_form stats-eval">
                <input type="text" id="player_stat_5_form_now" class="span2 img_form stats-nows">
                <input type="text" id="player_stat_5_form_win" class="span2 img_form  stats-wins">
                <input type="text" id="player_stat_5_form_hands" class="span2 img_form stats-hands">
                </div>
            </div>
            <div class="span2">
                <div class="center-div">
                <input type="text" id="player_stat_6_form_eval" class="span2 img_form stats-eval">
                <input type="text" id="player_stat_6_form_now" class="span2 img_form stats-nows">
                <input type="text" id="player_stat_6_form_win" class="span2 img_form  stats-wins">
                <input type="text" id="player_stat_6_form_hands" class="span2 img_form stats-hands">
                </div>
            </div>
        </div>

        <hr />

        <footer>
            <p>&copy; Poker App' 2013</p>
        </footer>

    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="/fanstatic/jquery/jquery.js"></script>
    <script src="/fanstatic/jquery/jquery.websocket.js"></script>
    <script src="/fanstatic/bootstrap/js/bootstrap.js"></script>
<script>

(function ($) {

    var websocket = undefined,
        img_list = [
            "table",
            "player_1_card_1",
            "player_1_card_2",
            "player_1_name",
            "player_2_cards",
            "player_2_name",
            "player_3_cards",
            "player_3_name",
            "player_4_cards",
            "player_4_name",
            "player_5_cards",
            "player_5_name",
            "player_6_cards",
            "player_6_name",
            "table_card_1",
            "table_card_2",
            "table_card_3",
            "table_card_4",
            "table_card_5"
    ];

    onmessage = function(e) {

        var o = JSON.parse(e.data);

        if (o.table_img) {

            console.log("table: " + o.table_img);

            $.each(img_list, function(i, img_name) {

                console.log(img_name + ": " + JSON.stringify(o.zones[img_name]));

                $("#" + img_name).pokerImage({
                    img: o.table_img,
                    zone: o.zones[img_name]
                });

                if (img_name != "table") {

                    console.log(img_name + ": " + JSON.stringify(o.infos[img_name]));

                    $("#" + img_name + "_form").pokerInfo({
                        info: o.infos[img_name],
                        evals: o.stats.evals,
                        stats: o.stats.stats
                    });

                    $("#info_step").val(o.stats.step.name);
                    $("#info_hand").val(o.stats.hand.name);

                }
            });
        }

        if (o.msg)
            console.log(o.msg)
    };

    $.fn.pokerImage = function (o) {

        var _default = {
            img: undefined,
            zone: {x: 0, y: 0, w: 0, h: 0}
            },
            o = $.extend(_default, o);

        return this.each(function () {

            var self = $(this);

            if (o.img) {
                self.css("backgroundImage", "url(" + o.img + ")");
                self.css("backgroundPositionX", o.zone.x + "px");
                self.css("backgroundPositionY", o.zone.y + "px")
                self.css("width", o.zone.w + "px")
                self.css("height", o.zone.h + "px")
            }
        });
    };

    $.fn.pokerInfo = function (o) {

        var _default = {
            info: undefined
            },
            o = $.extend(_default, o);

        return this.each(function () {

            var self = $(this),
                is_player = self.attr("id").substr(0, 6)=="player",
                is_player_name = self.attr("id").substr(9, 4)=="name",
                player_num_ = is_player_name? self.attr("id").substr(7, 1):undefined,
                in_eval = is_player_name?$("#player_stat_" + player_num_  + "_form_eval"):undefined,
                in_now = is_player_name?$("#player_stat_" + player_num_  + "_form_now"):undefined,
                in_win = is_player_name?$("#player_stat_" + player_num_  + "_form_win"):undefined,
                in_hands = is_player_name?$("#player_stat_" + player_num_  + "_form_hands"):undefined;
                eval = is_player_name&&o.evals&&o.info in o.evals?o.evals[o.info]:'',
                stats = is_player_name&&o.stats&&o.info in o.stats?o.stats[o.info]:undefined,
                now = stats?stats.now:'',
                win = stats?stats.win:'',
                hands = stats?stats.hands:'';

            self.val(o.info);

            // manage stats
            if (is_player_name) {
                in_eval.val(eval);
                in_now.val(now);
                in_win.val(win);
                in_hands.val(hands);
            }
        });
    };

    $.fn.pokerTable = function (o) {

        var _default = {},
            o = $.extend(_default, o);

        return this.each(function () {

            var self = $(this);

            $.post(
                "http://localhost:8080/socket",
                {
                    factory: "preview-table"
                },
                function(data) {

                    var url = data["west.socket:url"];

                    websocket = new WebSocket(url);
                    websocket.onmessage = onmessage; 

                    console.log("connected to: "+ url);

                    self.find(".prev").click(function () {
                        websocket.send(JSON.stringify({
                            action: "prev",
                            current: $("#table").css("backgroundImage")
                        }));
                    });

                    self.find(".next").click(function () {
                        websocket.send(JSON.stringify({
                            action: "next",
                            current: $("#table").css("backgroundImage")
                        }));
                    });

                    self.find(".preview").click(function () {
                        websocket.send(JSON.stringify({
                            action: "preview",
                        }));
                    });

                    self.find(".save").click(function () {
                        websocket.send(JSON.stringify({
                            action: "save",
                        }));
                    });
                },
                "json"
            );
        });
    };

    $.fn.pokerForms = function (o) {

        var _default = {},
            o = $.extend(_default, o);

        return this.each(function () {

            var self = $(this);

            self.change(function () {

                console.log(self.val());

                websocket.send(JSON.stringify({
                    action: "form",
                    current: $("#table").css("backgroundImage"),
                    form: self.attr("id").replace("_form", ""),
                    value: self.val()
                }));
            })            
        });
    };


    $.fn.pokerShow = function (o) {

        var _default = {},
            o = $.extend(_default, o);

        return this.each(function () {

            var self    = $(this),
                target  = $("." + self.attr("id").replace("_show", ""));

            // hide all
            // target.hide();

            self.click(function () {
    
                var current = $("#table").css("backgroundImage"),
                    visible = target.first().css("display");

                if (current != "none" && visible == "none")
                    target.show()
                else 
                    target.hide()
            });
        });
    };
})(jQuery);

$("#poker_table").pokerTable();
$(".img_form").pokerForms();
$(".hideable").pokerShow();

</script>
</body>
</html>
